- Feature Name: `block_metadata`
- Start Date: 2022-05-24
- MCIP PR: [mobilecoinfoundation/mcips#43](https://github.com/mobilecoinfoundation/mcips/pull/43)
- Tracking Issue: https://github.com/mobilecoinfoundation/mobilecoin/issues/2104

Contents:

- [Summary](#summary)
- [Motivation](#motivation)
- [Guide-level explanation](#guide-level-explanation)
- [Reference-level explanation](#reference-level-explanation)
  - [Protobuf schema](#protobuf-schema)
  - [Signing metadata](#signing-metadata)
  - [Trusted Signing Keys](#trusted-signing-keys)
  - [Historical AVRs](#historical-avrs)
  - [Block Version bump](#block-version-bump)
- [Drawbacks](#drawbacks)
- [Rationale and alternatives](#rationale-and-alternatives)
  - [Alternatives considered](#alternatives-considered)
- [Prior art](#prior-art)
- [Unresolved questions](#unresolved-questions)
- [Future possibilities](#future-possibilities)

# Summary

Add metadata to the blockchain, with consensus nodes reporting the Attestation
Verification Report (AVR) of their enclaves, SCP message signing key, and quorum
set at the time a block was externalized.

# Motivation

Currently if one wants to prove blocks were generated by the MobileCoin network
(say instead of a forged chain), the information required to prove this is hard
to obtain.

# Guide-level explanation

When consensus nodes externalize a block, they will include `BlockMetadata` with
the AVR, quorum set, and SCP message signing public key, encoding the network
state as of that moment. LedgerDB and WatcherDB also track and persist the block
metadata.

Note that while the `BlockMetadata` can be used to verify chain integrity, it
couldn't be used to falsify any new transactions or blocks.

All clients SHOULD authenticate metadata when present (regardless of block
version), and reject blocks that cannot be authenticated, per the following
criteria:

1. Verify that the metadata signature is valid for its contents and pub key.
1. The metadata signer is a [Trusted Signing Key](#trusted-signing-keys) valid
   for the block index.
1. The metadata includes an AVR signed by Intel Attestation Service.
1. The key used to generate the block signature is contained in the AVR.

Block metadata becomes required with block version 3.

# Reference-level explanation

Add a `message BlockMetadata` to `blockchain.ArchiveBlock`, and an analogous
`struct BlockMetadata` to `mc_blockchain_types::BlockData`.

## Protobuf schema

```protobuf
message BlockMetadataContents {
    /// The Block ID.
    BlockID id = 1;

    /// Quorum set configuration at the time of externalization.
    QuorumSet quorum_set = 2;

    /// IAS report for the enclave which generated the signature.
    VerificationReport verification_report = 3;

    /// Responder ID of the consensus node.
    ResponderId responder_id = 4;
}

message BlockMetadata {
    /// Metadata signed by the consensus node.
    BlockMetadataContents contents = 1;

    /// Message signing key.
    Ed25519Public node_key = 2;

    /// Signature using `node_key` over the Digestible encoding of `contents`.
    Ed25519Signature signature = 3;
}

// NB: Only addition is field #4.
message ArchiveBlockV1 {
    /// Block.
    Block block = 1;

    /// Contents of the block.
    BlockContents block_contents = 2;

    /// Block signature.
    BlockSignature signature = 3;

    /// Additional signed metadata about this block.
    BlockMetadata metadata = 4;
}
```

Since this is a protobuf-additive change, we don't need a new `ArchiveBlock`
version/type.

## Signing metadata

The metadata signature will always differ from the block signature. The block
signature is generated by the enclave using a private key that never leaves the
enclave, while the metadata is signed by the "untrusted" code outside the
enclave using the SCP message signing key, since the enclave does not have this
metadata.

The metadata signature is generated from the `Digestible` encoding of
`BlockMetadataContents`, since the protobuf wire format is not a canonical
encoding.

## Trusted Signing Keys

A key piece of authenticating signed data is knowing which public keys to trust.

MobileCoin Foundation will publish a configuration file mapping node_id+pub_key
to a range of block indexes for which that key is trusted, which node operators
and consumers can use to verify the metadata signatures. This provides a
mechanism for revoking compromised keys.

This mapping will contain multiple node_id:pub_key:block_range entries, in the
formats defined below.

#### Trusted Signing Keys TOML format

```toml
[[node]]
# Responder ID for the consensus node.
responder_id = ""
# Pub key, as hex-encoded or PEM-encoded data or a PEM file path.
message_signing_pub_key = "..."
# Index of the first block signed with this key.
first_block_index = X
# Optional index of the last trusted block signed with this key.
last_block_index = Y
```

#### Trusted Signing Keys JSON format

```json
{
  "node": [
    {
      "responder_id": "...",
      "message_signing_pub_key": "...",
      "first_block_index": 0,
      "last_block_index": 42
    }
  ]
}
```

## Historical AVRs

The Block Signing Key used to sign a block is included within the `isvQuoteBody`
field of an Intel AVR. By having AVRs available on chain, anyone can verify the
reported block signing key is correct and that the block was signed by a
consensus node with a valid enclave and a recognized SCP message signing key.

Ledger DB will default to reading AVRs from `BlockMetadata`, and fall back to a
lookup table containing AVRs for older blocks.

MobileCoin Foundation will publish a bootstrap file defining this lookup table
with historical consensus enclave AVRs, up to when consensus nodes publish
`BlockMetadata` with their AVRs.

Operators may not have complete historical AVR data, in which case the block
range should be listed in the file, without the AVR fields.

#### AVR History TOML format

```toml
[[node]]
# Responder ID for the consensus node.
responder_id = ""
# Index of the first block signed with this enclave.
first_block_index = X
# Optional index of the last block signed with this enclave.
last_block_index = Y
# Optional AVR
[node.avr]
# Hex-encoded signature bytes
sig = "..."
# An array of hex-encoded pub key bytes
chain = ["x", "y"]
# IAS HTTP response body
http_body = '{...}'
```

<details>

<summary>Sample data</summary>

```toml
[[node]]
responder_id = 'node1.prod.mobilecoinww.com'
first_block_index = 0
last_block_index = 479

[[node]]
responder_id = 'node1.prod.mobilecoinww.com'
first_block_index = 480
last_block_index = 10399

[node.avr]
sig = '827d20aa5126c456d95024f584d6fa6c3c476fe408995bedbc23e1541e3449f873e0f91219e71796976954ed9245a28a203c27d5bd5b9cc8597f2f36861c6a9ef415e92a6a27bb857106e5607e3346c0e2ecab3b49a3bab8a176f371de3b5c3e551289460ce62b74e3a55d78a8f7f3139720e389ce9b688eb3fc01c76b2f057936b3de605f4348a4a98a9e182f6d16c652e3f5e07e6cb53966021186fa28ed47cc71611c390a45eaf19645f3898b5f2f2cc02ea754ec1061bcb5965649ead1352da6af55f776d137a82b1461ce0d44421e37554704dae13eb14410c12f3a4cf3c73c24f4029557071cd90375134c03e12def3960b54d64e44c5592ad5c6721bd'
chain = [
    '308204a130820309a003020102020900d107765d32a3b096300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341301e170d3136313132323039333635385a170d3236313132303039333635385a307b310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e312d302b06035504030c24496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e6730820122300d06092a864886f70d01010105000382010f003082010a0282010100a97a2de0e66ea6147c9ee745ac0162686c7192099afc4b3f040fad6de093511d74e802f510d716038157dcaf84f4104bd3fed7e6b8f99c8817fd1ff5b9b864296c3d81fa8f1b729e02d21d72ffee4ced725efe74bea68fbc4d4244286fcdd4bf64406a439a15bcb4cf67754489c423972b4a80df5c2e7c5bc2dbaf2d42bb7b244f7c95bf92c75d3b33fc5410678a89589d1083da3acc459f2704cd99598c275e7c1878e00757e5bdb4e840226c11c0a17ff79c80b15c1ddb5af21cc2417061fbd2a2da819ed3b72b7efaa3bfebe2805c9b8ac19aa346512d484cfc81941e15f55881cc127e8f7aa12300cd5afb5742fa1d20cb467a5beb1c666cf76a368978b50203010001a381a43081a1301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff0404030206c0300c0603551d130101ff0402300030600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c300d06092a864886f70d01010b050003820181006708b61b5c2bd215473e2b46af99284fbb939d3f3b152c996f1a6af3b329bd220b1d3b610f6bce2e6753bded304db21912f385256216cfcba456bd96940be892f5690c260d1ef84f1606040222e5fe08e5326808212a447cfdd64a46e94bf29f6b4b9a721d25b3c4e2f62f58baed5d77c505248f0f801f9fbfb7fd752080095cee80938b339f6dbb4e165600e20e4a718812d49d9901e310a9b51d66c79909c6996599fae6d76a79ef145d9943bf1d3e35d3b42d1fb9a45cbe8ee334c166eee7d32fcdc9935db8ec8bb1d8eb3779dd8ab92b6e387f0147450f1e381d08581fb83df33b15e000a59be57ea94a3a52dc64bdaec959b3464c91e725bbdaea3d99e857e380a23c9d9fb1ef58e9e42d71f12130f9261d7234d6c37e2b03dba40dfdfb13ac4ad8e13fd3756356b6b50015a3ec9580b815d87c2cef715cd28df00bbf2a3c403ebf6691b3f05edd9143803ca085cff57e053eec2f8fea46ea778a68c9be885bc28225bc5f309be4a2b74d3a03945319dd3c7122fed6ff53bb8b8cb3a03c',
    '3082054b308203b3a003020102020900d107765d32a3b094300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e672043413020170d3136313131343135333733315a180f32303439313233313233353935395a307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341308201a2300d06092a864886f70d01010105000382018f003082018a02820181009f3c647eb5773cbb512d2732c0d7415ebb55a0fa9ede2e649199e6821db910d53177370977466a6a5e4786ccd2ddebd4149d6a2f6325529dd10cc98737b0779c1a07e29c47a1ae004948476c489f45a5a15d7ac8ecc6acc645adb43d87679df59c093bc5a2e9696c5478541b979e754b573914be55d32ff4c09ddf27219934cd990527b3f92ed78fbf29246abecb71240ef39c2d7107b447545a7ffb10eb060a68a98580219e36910952683892d6a5e2a80803193e407531404e36b315623799aa825074409754a2dfe8f5afd5fe631e1fc2af3808906f28a790d9dd9fe060939b125790c5805d037df56a99531b96de69de33ed226cc1207d1042b5c9ab7f404fc711c0fe4769fb9578b1dc0ec469ea1a25e0ff9914886ef2699b235bb4847dd6ff40b606e6170793c2fb98b314587f9cfd257362dfeab10b3bd2d97673a1a4bd44c453aaf47fc1f2d3d0f384f74a06f89c089f0da6cdb7fceee8c9821a8e54f25c0416d18c46839a5f8012fbdd3dc74d256279adc2c0d55aff6f0622425d1b0203010001a381c93081c630600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c301d0603551d0e0416041478437b76a67ebcd0af7e4237eb357c3b8701513c301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff04040302010630120603551d130101ff040830060101ff020100300d06092a864886f70d01010b05000382018100785f2d60c5c80af42a797610213915da82c9b29e89e0902a25a6c75b16091c68ab204aae711889492c7e1e320911455a8fc13442312e77a63994d99795c8ea4576823cea8ad1e191cfa862fab8a932d3d9b0535a0702d0555f74e520e30330f33480e7adc9d7c81e20703142bf00c528a80b463381fd602a82c7035281aae59562ccb5334ea8903e650b010681f5ce8eb62eac9c414988243aec92f25bf13cdff7ebcc298ee51bba5a3538b66b26cbc45a51de003cad306531ad7cf5d4ef0f8805d1b9133d24135ab3c4641a2f8808349d7333295e0e76ee4bc5227232628efa80d79d92ab4e3d1120f3fb5ad119cd8d544aa1d4a6865e6b57beac5771307e2e3cb9070da47b4bfc8869e01413ea093541de8a792811b74636c5e91452cf0cee59f2fb404acd0bc584cb9c835404734c0e7ec6605cdfcf2ff439b6d4719f702f0e0c3fa04fdb12a6cb2ad1ab1c9af1f8f4c3a08edd72a32b0bb5d0ad256ffd159a683b2a5a1f1d11fa62532f03d754caef0da5735a1e5a884c7e89d91218c9d7',
]
http_body = '{"nonce":"0edca460aa5c7c9a952526ee904111f6","id":"239437120075880885026599322830514941911","timestamp":"2021-03-08T16:32:15.337612","version":4,"epidPseudonym":"gKH0dexEpYfuyaGgaKKWmH4VJ8r0L3af1W//p6ya+WaN9BAlSW1Gj3NOWvrQIEAyLCof3fwS9pkLnZrYk3CXQFlpkTmn56hip16QlU876R7o0WpMfIpTY0VVyFj0kM3pAoSIeurvSGDNLrkq1qdKin3mPC2DwzsL1TdEs2ECbkI=","advisoryURL":"https://security-center.intel.com","advisoryIDs":["INTEL-SA-00334"],"isvEnclaveQuoteStatus":"SW_HARDENING_NEEDED","isvEnclaveQuoteBody":"AgABAP4LAAALAAoAAAAAAL3lg34HPOkq5u/y0l94xuMAAAAAAAAAAAAAAAAAAAAAEREDBf+ABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAHAAAAAAAAAOZts4uKQ6M/bBYQ0zWjYZY7srMeBWrw3AqJWsbIV8q5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsGlYcSrZMvAS/pEXN977Zsq1vawTTjTE382IrKf2zDgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACCQbFoCTirZ6Uvkspay6i0N3AKG+RG15miHkmNrloKRafPBVg+aovhB0Yxr5DBnb+p0GM2A6Wmm1IOXiOma5os"}'

[[node]]
responder_id = 'node1.prod.mobilecoinww.com'
first_block_index = 10400
last_block_index = 11021

[node.avr]
sig = '5032be9bd3de284f2b2cd4ae6a77866f83f2fa5ecc7999abd370fb924f25a588b3f4e5693f45dfbf3ecde3e68d55772bfed1ac69e3dcbb7873f1e314b7ceb183e38791c0058a337d3cb316cd134c83710aecd03b3a8c86701dfef9012d86ac8e2c1b9bfb7a22138517ae9649fffb436583108d6f64cf6a282246f2eeb8f5f7ee7090ec9879efdb7903f8f2e70cfe308e10ca4dc5d6991e8ba1c4c93848936cd43fe86db27beffbc58de3059e2bb8303430cdf933fe4a7bf39d13aaa24132971a087bfc5c9ec2c87fbeeaf6b2ab255ec4792136a4819c74cbca0377b1b1edb294b13a9fcee0c56162e0b971bf75cdfd2718bc235ef2059c7fc583fbf68d274ab3'
chain = [
    '308204a130820309a003020102020900d107765d32a3b096300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341301e170d3136313132323039333635385a170d3236313132303039333635385a307b310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e312d302b06035504030c24496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e6730820122300d06092a864886f70d01010105000382010f003082010a0282010100a97a2de0e66ea6147c9ee745ac0162686c7192099afc4b3f040fad6de093511d74e802f510d716038157dcaf84f4104bd3fed7e6b8f99c8817fd1ff5b9b864296c3d81fa8f1b729e02d21d72ffee4ced725efe74bea68fbc4d4244286fcdd4bf64406a439a15bcb4cf67754489c423972b4a80df5c2e7c5bc2dbaf2d42bb7b244f7c95bf92c75d3b33fc5410678a89589d1083da3acc459f2704cd99598c275e7c1878e00757e5bdb4e840226c11c0a17ff79c80b15c1ddb5af21cc2417061fbd2a2da819ed3b72b7efaa3bfebe2805c9b8ac19aa346512d484cfc81941e15f55881cc127e8f7aa12300cd5afb5742fa1d20cb467a5beb1c666cf76a368978b50203010001a381a43081a1301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff0404030206c0300c0603551d130101ff0402300030600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c300d06092a864886f70d01010b050003820181006708b61b5c2bd215473e2b46af99284fbb939d3f3b152c996f1a6af3b329bd220b1d3b610f6bce2e6753bded304db21912f385256216cfcba456bd96940be892f5690c260d1ef84f1606040222e5fe08e5326808212a447cfdd64a46e94bf29f6b4b9a721d25b3c4e2f62f58baed5d77c505248f0f801f9fbfb7fd752080095cee80938b339f6dbb4e165600e20e4a718812d49d9901e310a9b51d66c79909c6996599fae6d76a79ef145d9943bf1d3e35d3b42d1fb9a45cbe8ee334c166eee7d32fcdc9935db8ec8bb1d8eb3779dd8ab92b6e387f0147450f1e381d08581fb83df33b15e000a59be57ea94a3a52dc64bdaec959b3464c91e725bbdaea3d99e857e380a23c9d9fb1ef58e9e42d71f12130f9261d7234d6c37e2b03dba40dfdfb13ac4ad8e13fd3756356b6b50015a3ec9580b815d87c2cef715cd28df00bbf2a3c403ebf6691b3f05edd9143803ca085cff57e053eec2f8fea46ea778a68c9be885bc28225bc5f309be4a2b74d3a03945319dd3c7122fed6ff53bb8b8cb3a03c',
    '3082054b308203b3a003020102020900d107765d32a3b094300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e672043413020170d3136313131343135333733315a180f32303439313233313233353935395a307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341308201a2300d06092a864886f70d01010105000382018f003082018a02820181009f3c647eb5773cbb512d2732c0d7415ebb55a0fa9ede2e649199e6821db910d53177370977466a6a5e4786ccd2ddebd4149d6a2f6325529dd10cc98737b0779c1a07e29c47a1ae004948476c489f45a5a15d7ac8ecc6acc645adb43d87679df59c093bc5a2e9696c5478541b979e754b573914be55d32ff4c09ddf27219934cd990527b3f92ed78fbf29246abecb71240ef39c2d7107b447545a7ffb10eb060a68a98580219e36910952683892d6a5e2a80803193e407531404e36b315623799aa825074409754a2dfe8f5afd5fe631e1fc2af3808906f28a790d9dd9fe060939b125790c5805d037df56a99531b96de69de33ed226cc1207d1042b5c9ab7f404fc711c0fe4769fb9578b1dc0ec469ea1a25e0ff9914886ef2699b235bb4847dd6ff40b606e6170793c2fb98b314587f9cfd257362dfeab10b3bd2d97673a1a4bd44c453aaf47fc1f2d3d0f384f74a06f89c089f0da6cdb7fceee8c9821a8e54f25c0416d18c46839a5f8012fbdd3dc74d256279adc2c0d55aff6f0622425d1b0203010001a381c93081c630600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c301d0603551d0e0416041478437b76a67ebcd0af7e4237eb357c3b8701513c301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff04040302010630120603551d130101ff040830060101ff020100300d06092a864886f70d01010b05000382018100785f2d60c5c80af42a797610213915da82c9b29e89e0902a25a6c75b16091c68ab204aae711889492c7e1e320911455a8fc13442312e77a63994d99795c8ea4576823cea8ad1e191cfa862fab8a932d3d9b0535a0702d0555f74e520e30330f33480e7adc9d7c81e20703142bf00c528a80b463381fd602a82c7035281aae59562ccb5334ea8903e650b010681f5ce8eb62eac9c414988243aec92f25bf13cdff7ebcc298ee51bba5a3538b66b26cbc45a51de003cad306531ad7cf5d4ef0f8805d1b9133d24135ab3c4641a2f8808349d7333295e0e76ee4bc5227232628efa80d79d92ab4e3d1120f3fb5ad119cd8d544aa1d4a6865e6b57beac5771307e2e3cb9070da47b4bfc8869e01413ea093541de8a792811b74636c5e91452cf0cee59f2fb404acd0bc584cb9c835404734c0e7ec6605cdfcf2ff439b6d4719f702f0e0c3fa04fdb12a6cb2ad1ab1c9af1f8f4c3a08edd72a32b0bb5d0ad256ffd159a683b2a5a1f1d11fa62532f03d754caef0da5735a1e5a884c7e89d91218c9d7',
]
http_body = '{"nonce":"fe89bd7386cdc13787dbb50b27917030","id":"166196848040908016823295613654479498765","timestamp":"2021-06-24T18:57:44.075285","version":4,"epidPseudonym":"gKH0dexEpYfuyaGgaKKWmH4VJ8r0L3af1W//p6ya+WaN9BAlSW1Gj3NOWvrQIEAyLCof3fwS9pkLnZrYk3CXQC7VlPZs6EsMzqr40q2S7ObH6Qxq5SI6JNc18NIfOZ8+43l5j4yck2OD4g4J2fX5f2bnlaiWaRTcvtF7xnSCs/k=","advisoryURL":"https://security-center.intel.com","advisoryIDs":["INTEL-SA-00334"],"isvEnclaveQuoteStatus":"SW_HARDENING_NEEDED","isvEnclaveQuoteBody":"AgABABMMAAAMAAsAAAAAAL3lg34HPOkq5u/y0l94xuMAAAAAAAAAAAAAAAAAAAAAEREDBf+ABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAHAAAAAAAAAGUyKK/SsCpsKPHcOxCLHfpFfRcLMq6OwpePlBvRZVyDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsGlYcSrZMvAS/pEXN977Zsq1vawTTjTE382IrKf2zDgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwd71Ni3xBrMF22K0CWRUZPzdE9GwSDkFoiuhQcee9R/Qyoz4HOFMtNl1HY74q8e0fWOh7yxmlply0fZ2eREZj"}'
```

</details>

#### AVR History JSON format

```json
{
  "node": [
    {
      "responder_id": "",
      "first_block_index": 0,
      "last_block_index": 42,
      "avr": {
        "sig": "...",
        "chain": ["x", "y"],
        "http_body": "{...}"
      }
    }
  ]
}
```

<details>

<summary>Sample data</summary>

```json
{
  "node": [
    {
      "responder_id": "node1.prod.mobilecoinww.com",
      "first_block_index": 0,
      "last_block_index": 480,
      "avr": null
    },
    {
      "responder_id": "node1.prod.mobilecoinww.com",
      "first_block_index": 481,
      "last_block_index": 10399,
      "avr": {
        "sig": "827d20aa5126c456d95024f584d6fa6c3c476fe408995bedbc23e1541e3449f873e0f91219e71796976954ed9245a28a203c27d5bd5b9cc8597f2f36861c6a9ef415e92a6a27bb857106e5607e3346c0e2ecab3b49a3bab8a176f371de3b5c3e551289460ce62b74e3a55d78a8f7f3139720e389ce9b688eb3fc01c76b2f057936b3de605f4348a4a98a9e182f6d16c652e3f5e07e6cb53966021186fa28ed47cc71611c390a45eaf19645f3898b5f2f2cc02ea754ec1061bcb5965649ead1352da6af55f776d137a82b1461ce0d44421e37554704dae13eb14410c12f3a4cf3c73c24f4029557071cd90375134c03e12def3960b54d64e44c5592ad5c6721bd",
        "chain": [
          "308204a130820309a003020102020900d107765d32a3b096300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341301e170d3136313132323039333635385a170d3236313132303039333635385a307b310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e312d302b06035504030c24496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e6730820122300d06092a864886f70d01010105000382010f003082010a0282010100a97a2de0e66ea6147c9ee745ac0162686c7192099afc4b3f040fad6de093511d74e802f510d716038157dcaf84f4104bd3fed7e6b8f99c8817fd1ff5b9b864296c3d81fa8f1b729e02d21d72ffee4ced725efe74bea68fbc4d4244286fcdd4bf64406a439a15bcb4cf67754489c423972b4a80df5c2e7c5bc2dbaf2d42bb7b244f7c95bf92c75d3b33fc5410678a89589d1083da3acc459f2704cd99598c275e7c1878e00757e5bdb4e840226c11c0a17ff79c80b15c1ddb5af21cc2417061fbd2a2da819ed3b72b7efaa3bfebe2805c9b8ac19aa346512d484cfc81941e15f55881cc127e8f7aa12300cd5afb5742fa1d20cb467a5beb1c666cf76a368978b50203010001a381a43081a1301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff0404030206c0300c0603551d130101ff0402300030600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c300d06092a864886f70d01010b050003820181006708b61b5c2bd215473e2b46af99284fbb939d3f3b152c996f1a6af3b329bd220b1d3b610f6bce2e6753bded304db21912f385256216cfcba456bd96940be892f5690c260d1ef84f1606040222e5fe08e5326808212a447cfdd64a46e94bf29f6b4b9a721d25b3c4e2f62f58baed5d77c505248f0f801f9fbfb7fd752080095cee80938b339f6dbb4e165600e20e4a718812d49d9901e310a9b51d66c79909c6996599fae6d76a79ef145d9943bf1d3e35d3b42d1fb9a45cbe8ee334c166eee7d32fcdc9935db8ec8bb1d8eb3779dd8ab92b6e387f0147450f1e381d08581fb83df33b15e000a59be57ea94a3a52dc64bdaec959b3464c91e725bbdaea3d99e857e380a23c9d9fb1ef58e9e42d71f12130f9261d7234d6c37e2b03dba40dfdfb13ac4ad8e13fd3756356b6b50015a3ec9580b815d87c2cef715cd28df00bbf2a3c403ebf6691b3f05edd9143803ca085cff57e053eec2f8fea46ea778a68c9be885bc28225bc5f309be4a2b74d3a03945319dd3c7122fed6ff53bb8b8cb3a03c",
          "3082054b308203b3a003020102020900d107765d32a3b094300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e672043413020170d3136313131343135333733315a180f32303439313233313233353935395a307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341308201a2300d06092a864886f70d01010105000382018f003082018a02820181009f3c647eb5773cbb512d2732c0d7415ebb55a0fa9ede2e649199e6821db910d53177370977466a6a5e4786ccd2ddebd4149d6a2f6325529dd10cc98737b0779c1a07e29c47a1ae004948476c489f45a5a15d7ac8ecc6acc645adb43d87679df59c093bc5a2e9696c5478541b979e754b573914be55d32ff4c09ddf27219934cd990527b3f92ed78fbf29246abecb71240ef39c2d7107b447545a7ffb10eb060a68a98580219e36910952683892d6a5e2a80803193e407531404e36b315623799aa825074409754a2dfe8f5afd5fe631e1fc2af3808906f28a790d9dd9fe060939b125790c5805d037df56a99531b96de69de33ed226cc1207d1042b5c9ab7f404fc711c0fe4769fb9578b1dc0ec469ea1a25e0ff9914886ef2699b235bb4847dd6ff40b606e6170793c2fb98b314587f9cfd257362dfeab10b3bd2d97673a1a4bd44c453aaf47fc1f2d3d0f384f74a06f89c089f0da6cdb7fceee8c9821a8e54f25c0416d18c46839a5f8012fbdd3dc74d256279adc2c0d55aff6f0622425d1b0203010001a381c93081c630600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c301d0603551d0e0416041478437b76a67ebcd0af7e4237eb357c3b8701513c301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff04040302010630120603551d130101ff040830060101ff020100300d06092a864886f70d01010b05000382018100785f2d60c5c80af42a797610213915da82c9b29e89e0902a25a6c75b16091c68ab204aae711889492c7e1e320911455a8fc13442312e77a63994d99795c8ea4576823cea8ad1e191cfa862fab8a932d3d9b0535a0702d0555f74e520e30330f33480e7adc9d7c81e20703142bf00c528a80b463381fd602a82c7035281aae59562ccb5334ea8903e650b010681f5ce8eb62eac9c414988243aec92f25bf13cdff7ebcc298ee51bba5a3538b66b26cbc45a51de003cad306531ad7cf5d4ef0f8805d1b9133d24135ab3c4641a2f8808349d7333295e0e76ee4bc5227232628efa80d79d92ab4e3d1120f3fb5ad119cd8d544aa1d4a6865e6b57beac5771307e2e3cb9070da47b4bfc8869e01413ea093541de8a792811b74636c5e91452cf0cee59f2fb404acd0bc584cb9c835404734c0e7ec6605cdfcf2ff439b6d4719f702f0e0c3fa04fdb12a6cb2ad1ab1c9af1f8f4c3a08edd72a32b0bb5d0ad256ffd159a683b2a5a1f1d11fa62532f03d754caef0da5735a1e5a884c7e89d91218c9d7"
        ],
        "http_body": "{\"nonce\":\"0edca460aa5c7c9a952526ee904111f6\",\"id\":\"239437120075880885026599322830514941911\",\"timestamp\":\"2021-03-08T16:32:15.337612\",\"version\":4,\"epidPseudonym\":\"gKH0dexEpYfuyaGgaKKWmH4VJ8r0L3af1W//p6ya+WaN9BAlSW1Gj3NOWvrQIEAyLCof3fwS9pkLnZrYk3CXQFlpkTmn56hip16QlU876R7o0WpMfIpTY0VVyFj0kM3pAoSIeurvSGDNLrkq1qdKin3mPC2DwzsL1TdEs2ECbkI=\",\"advisoryURL\":\"https://security-center.intel.com\",\"advisoryIDs\":[\"INTEL-SA-00334\"],\"isvEnclaveQuoteStatus\":\"SW_HARDENING_NEEDED\",\"isvEnclaveQuoteBody\":\"AgABAP4LAAALAAoAAAAAAL3lg34HPOkq5u/y0l94xuMAAAAAAAAAAAAAAAAAAAAAEREDBf+ABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAHAAAAAAAAAOZts4uKQ6M/bBYQ0zWjYZY7srMeBWrw3AqJWsbIV8q5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsGlYcSrZMvAS/pEXN977Zsq1vawTTjTE382IrKf2zDgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACCQbFoCTirZ6Uvkspay6i0N3AKG+RG15miHkmNrloKRafPBVg+aovhB0Yxr5DBnb+p0GM2A6Wmm1IOXiOma5os\"}"
      }
    },
    {
      "responder_id": "node1.prod.mobilecoinww.com",
      "first_block_index": 10400,
      "last_block_index": 11021,
      "avr": {
        "sig": "5032be9bd3de284f2b2cd4ae6a77866f83f2fa5ecc7999abd370fb924f25a588b3f4e5693f45dfbf3ecde3e68d55772bfed1ac69e3dcbb7873f1e314b7ceb183e38791c0058a337d3cb316cd134c83710aecd03b3a8c86701dfef9012d86ac8e2c1b9bfb7a22138517ae9649fffb436583108d6f64cf6a282246f2eeb8f5f7ee7090ec9879efdb7903f8f2e70cfe308e10ca4dc5d6991e8ba1c4c93848936cd43fe86db27beffbc58de3059e2bb8303430cdf933fe4a7bf39d13aaa24132971a087bfc5c9ec2c87fbeeaf6b2ab255ec4792136a4819c74cbca0377b1b1edb294b13a9fcee0c56162e0b971bf75cdfd2718bc235ef2059c7fc583fbf68d274ab3",
        "chain": [
          "308204a130820309a003020102020900d107765d32a3b096300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341301e170d3136313132323039333635385a170d3236313132303039333635385a307b310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e312d302b06035504030c24496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e6730820122300d06092a864886f70d01010105000382010f003082010a0282010100a97a2de0e66ea6147c9ee745ac0162686c7192099afc4b3f040fad6de093511d74e802f510d716038157dcaf84f4104bd3fed7e6b8f99c8817fd1ff5b9b864296c3d81fa8f1b729e02d21d72ffee4ced725efe74bea68fbc4d4244286fcdd4bf64406a439a15bcb4cf67754489c423972b4a80df5c2e7c5bc2dbaf2d42bb7b244f7c95bf92c75d3b33fc5410678a89589d1083da3acc459f2704cd99598c275e7c1878e00757e5bdb4e840226c11c0a17ff79c80b15c1ddb5af21cc2417061fbd2a2da819ed3b72b7efaa3bfebe2805c9b8ac19aa346512d484cfc81941e15f55881cc127e8f7aa12300cd5afb5742fa1d20cb467a5beb1c666cf76a368978b50203010001a381a43081a1301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff0404030206c0300c0603551d130101ff0402300030600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c300d06092a864886f70d01010b050003820181006708b61b5c2bd215473e2b46af99284fbb939d3f3b152c996f1a6af3b329bd220b1d3b610f6bce2e6753bded304db21912f385256216cfcba456bd96940be892f5690c260d1ef84f1606040222e5fe08e5326808212a447cfdd64a46e94bf29f6b4b9a721d25b3c4e2f62f58baed5d77c505248f0f801f9fbfb7fd752080095cee80938b339f6dbb4e165600e20e4a718812d49d9901e310a9b51d66c79909c6996599fae6d76a79ef145d9943bf1d3e35d3b42d1fb9a45cbe8ee334c166eee7d32fcdc9935db8ec8bb1d8eb3779dd8ab92b6e387f0147450f1e381d08581fb83df33b15e000a59be57ea94a3a52dc64bdaec959b3464c91e725bbdaea3d99e857e380a23c9d9fb1ef58e9e42d71f12130f9261d7234d6c37e2b03dba40dfdfb13ac4ad8e13fd3756356b6b50015a3ec9580b815d87c2cef715cd28df00bbf2a3c403ebf6691b3f05edd9143803ca085cff57e053eec2f8fea46ea778a68c9be885bc28225bc5f309be4a2b74d3a03945319dd3c7122fed6ff53bb8b8cb3a03c",
          "3082054b308203b3a003020102020900d107765d32a3b094300d06092a864886f70d01010b0500307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e672043413020170d3136313131343135333733315a180f32303439313233313233353935395a307e310b3009060355040613025553310b300906035504080c0243413114301206035504070c0b53616e746120436c617261311a3018060355040a0c11496e74656c20436f72706f726174696f6e3130302e06035504030c27496e74656c20534758204174746573746174696f6e205265706f7274205369676e696e67204341308201a2300d06092a864886f70d01010105000382018f003082018a02820181009f3c647eb5773cbb512d2732c0d7415ebb55a0fa9ede2e649199e6821db910d53177370977466a6a5e4786ccd2ddebd4149d6a2f6325529dd10cc98737b0779c1a07e29c47a1ae004948476c489f45a5a15d7ac8ecc6acc645adb43d87679df59c093bc5a2e9696c5478541b979e754b573914be55d32ff4c09ddf27219934cd990527b3f92ed78fbf29246abecb71240ef39c2d7107b447545a7ffb10eb060a68a98580219e36910952683892d6a5e2a80803193e407531404e36b315623799aa825074409754a2dfe8f5afd5fe631e1fc2af3808906f28a790d9dd9fe060939b125790c5805d037df56a99531b96de69de33ed226cc1207d1042b5c9ab7f404fc711c0fe4769fb9578b1dc0ec469ea1a25e0ff9914886ef2699b235bb4847dd6ff40b606e6170793c2fb98b314587f9cfd257362dfeab10b3bd2d97673a1a4bd44c453aaf47fc1f2d3d0f384f74a06f89c089f0da6cdb7fceee8c9821a8e54f25c0416d18c46839a5f8012fbdd3dc74d256279adc2c0d55aff6f0622425d1b0203010001a381c93081c630600603551d1f045930573055a053a051864f687474703a2f2f7472757374656473657276696365732e696e74656c2e636f6d2f636f6e74656e742f43524c2f5347582f4174746573746174696f6e5265706f72745369676e696e6743412e63726c301d0603551d0e0416041478437b76a67ebcd0af7e4237eb357c3b8701513c301f0603551d2304183016801478437b76a67ebcd0af7e4237eb357c3b8701513c300e0603551d0f0101ff04040302010630120603551d130101ff040830060101ff020100300d06092a864886f70d01010b05000382018100785f2d60c5c80af42a797610213915da82c9b29e89e0902a25a6c75b16091c68ab204aae711889492c7e1e320911455a8fc13442312e77a63994d99795c8ea4576823cea8ad1e191cfa862fab8a932d3d9b0535a0702d0555f74e520e30330f33480e7adc9d7c81e20703142bf00c528a80b463381fd602a82c7035281aae59562ccb5334ea8903e650b010681f5ce8eb62eac9c414988243aec92f25bf13cdff7ebcc298ee51bba5a3538b66b26cbc45a51de003cad306531ad7cf5d4ef0f8805d1b9133d24135ab3c4641a2f8808349d7333295e0e76ee4bc5227232628efa80d79d92ab4e3d1120f3fb5ad119cd8d544aa1d4a6865e6b57beac5771307e2e3cb9070da47b4bfc8869e01413ea093541de8a792811b74636c5e91452cf0cee59f2fb404acd0bc584cb9c835404734c0e7ec6605cdfcf2ff439b6d4719f702f0e0c3fa04fdb12a6cb2ad1ab1c9af1f8f4c3a08edd72a32b0bb5d0ad256ffd159a683b2a5a1f1d11fa62532f03d754caef0da5735a1e5a884c7e89d91218c9d7"
        ],
        "http_body": "{\"nonce\":\"fe89bd7386cdc13787dbb50b27917030\",\"id\":\"166196848040908016823295613654479498765\",\"timestamp\":\"2021-06-24T18:57:44.075285\",\"version\":4,\"epidPseudonym\":\"gKH0dexEpYfuyaGgaKKWmH4VJ8r0L3af1W//p6ya+WaN9BAlSW1Gj3NOWvrQIEAyLCof3fwS9pkLnZrYk3CXQC7VlPZs6EsMzqr40q2S7ObH6Qxq5SI6JNc18NIfOZ8+43l5j4yck2OD4g4J2fX5f2bnlaiWaRTcvtF7xnSCs/k=\",\"advisoryURL\":\"https://security-center.intel.com\",\"advisoryIDs\":[\"INTEL-SA-00334\"],\"isvEnclaveQuoteStatus\":\"SW_HARDENING_NEEDED\",\"isvEnclaveQuoteBody\":\"AgABABMMAAAMAAsAAAAAAL3lg34HPOkq5u/y0l94xuMAAAAAAAAAAAAAAAAAAAAAEREDBf+ABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAHAAAAAAAAAGUyKK/SsCpsKPHcOxCLHfpFfRcLMq6OwpePlBvRZVyDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsGlYcSrZMvAS/pEXN977Zsq1vawTTjTE382IrKf2zDgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwd71Ni3xBrMF22K0CWRUZPzdE9GwSDkFoiuhQcee9R/Qyoz4HOFMtNl1HY74q8e0fWOh7yxmlply0fZ2eREZj\"}"
      }
    }
  ]
}
```

</details>

## Block Version bump

Block version 3 will make the `block_metadata` required, at which point
consensus nodes and clients should reject blocks without metadata.

# Drawbacks

- This makes each block bigger (more bytes), but we gain an important ability to
  backfill a ledger from `ArchiveBlocks`.
- A introduces complexity around backfilling a ledger, namely looking up
  historical AVRs.
- Also entails additional configuration, with the associated operational cost.

# Rationale and alternatives

This addition of AVRs allows consumers to verify the blockchain with fewer data
sources, including post-hoc validation that the blocks were externalized by
legitimate consensus enclaves. This enables a single source of truth in the
steady state (rather than requiring a Watcher DB in addition to the actual block
data).

While this capability is necessary for block streaming, it is useful to decouple
the step of adding AVRs and quorum sets to the blockchain.

## Alternatives considered

#### Write metadata for older blocks

It would be nice if we can generate metadata for older blocks, as that would
keep the lookup logic simple, but we cannot generate signatures since MCF does
not have all the private signing keys, nor should it.

# Prior art

The author has not found any direct analogs for including network metadata in a
blockchain.

# Unresolved questions

None as of this writing.

# Future possibilities

1. Enables the streaming and archive APIs defined in
   [MCIP #29](0029-block-streaming.md) to use equivalent representations across
   the streaming and archive block APIs.

1. Enables block streaming and other consumers to include and validate the AVRs
   for persisted blocks, which opens a path to replacing mobilecoind and watcher
   in Fog.

   Note that block timestamps come from the block signature, and nodes that are
   catching up to the latest consensus (including mobilecoind, full-service, and
   consensus nodes that are catching up) do not append any block signature,
   relying on a Watcher to update the signatures (by syncing all blocks from
   multiple sources, at least one is guaranteed to contain a signature and a
   timestamp). Replacing Watcher thus entails updating this catch-up mode to
   handle block metadata and signatures, perhaps by fetching the same block from
   multiple sources until a quorum set check can be satisfied.
